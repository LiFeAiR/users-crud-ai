# HTTP Сервер с подключением к базе данных и REST API

Это реализация REST API сервера с возможностями подключения к базе данных.

## Структура проекта

```
.
├── api/
│   ├── grpc/
│   │   └── api.proto        # gRPC API спецификация
│   └── openapi/
│       └── api.yaml[api.swagger.json](api/openapi/api.swagger.json) # Спецификация OpenAPI
├── build/                   # Конфигурации сборки и развёртывания
│   ├── .env                 # Переменные окружения для Docker Compose
│   └── docker-compose.yml   # Конфигурация Docker Compose для базы данных PostgreSQL
├── cmd/
│   ├── app/
│   │   └── main.go          # Главная точка входа
│   └── cli/
│       └── main.go          # Точка входа CLI
├── internal/
│   ├── handlers/            # HTTP обработчики
│   ├── models/              # Модели данных
│   │   ├── organization.go  # Модель данных организации
│   │   ├── permission.go    # Модель данных прав
│   │   ├── role.go          # Модель данных ролей
│   │   ├── tariff.go        # Модель данных тарифов
│   │   └── user.go          # Модель данных пользователя
│   ├── repository/          # Подключение к базе данных и репозитории
│   │   ├── db.go            # Класс подключения к базе данных
│   │   ├── interface.go     # Интерфейс репозитория
│   │   ├── organization_repository.go  # Реализация репозитория организации
│   │   ├── permission_repository.go    # Реализация репозитория прав
│   │   ├── role_repository.go    # Реализация репозитория ролей
│   │   ├── tariff_repository.go    # Реализация репозитория тарифов
│   │   └── user_repository.go    # Реализация репозитория пользователя
│   └── server/              # Реализация HTTP сервера
└── go.mod                   # Файл модулей Go
```

## Сборка и развёртывание

Каталог `build` содержит конфигурационные файлы для сборки и развёртывания приложения с использованием Docker Compose и PostgreSQL:

- `.env`: Переменные окружения для настройки базы данных и pgAdmin
- `docker-compose.yml`: Конфигурация Docker Compose, которая настраивает службу базы данных PostgreSQL

Эти файлы позволяют легко запустить всё приложение с помощью одной команды с использованием Docker Compose.

## Класс подключения к базе данных

Класс подключения к базе данных находится в `internal/repository/db.go`. Он предоставляет:

- Подключение к базе данных PostgreSQL с использованием github.com/jackc/pgx/v5
- Проверку подключения
- Методы для получения и закрытия подключения к базе данных

### Пример использования

```go
// Создать новое подключение к базе данных
db, err := repository.NewDB("host=localhost port=5432 user=postgres password=postgres dbname=testdb sslmode=disable")
if err != nil {
log.Fatal("Не удалось подключиться к базе данных:", err)
}
defer db.Close()

// Получить подключение к базе данных
connection := db.GetConnection()

// Сервер управляет жизненным циклом подключения к базе данных
// и передаёт его обработчикам через базовый обработчик

Примечание: В продакшн средах управление подключениями к базе данных должно осуществляться более аккуратно,
чтобы предотвратить преждевременное закрытие соединений. В настоящее время соединение закрывается после
завершения метода Start, что не идеально для долгоживущих серверов.
```

## Реализация паттерна репозитория

Проект реализует паттерн репозитория в `internal/repository/`:

- Интерфейс `UserRepository` определяет методы для операций с пользователями (определено в `interface.go`)
- Структура `userRepository` реализует интерфейс (определено в `user_repository.go`)
- Интерфейс `OrganizationRepository` определяет методы для операций с организациями (определено в `interface.go`)
- Структура `organizationRepository` реализует интерфейс (определено в `organization_repository.go`)
- Оба репозитория используют одно и то же подключение к базе данных из `db.go`
- Предоставляет методы для операций CRUD с пользователями и организациями
- Включает инициализацию базы данных для обеих таблиц

## Интеграция обработчиков

HTTP обработчики в `internal/handlers/` теперь используют паттерн репозитория через базовый обработчик:

- Базовый обработчик получает экземпляры репозиториев для пользователей и организаций
- Обработчики получают экземпляр сервера для доступа к подключению к базе данных
- Фактическое взаимодействие с репозиторием делегируется базовому обработчику
- Все обработчики регистрируются через сервер в `internal/server/server.go`

## Конечные точки API

Сервер теперь поддерживает следующие конечные точки:

`GET /` - Корневая конечная точка

### Аутентификация

- `POST /api/login` - Вход пользователя (требуются email и password)

### Пользователи

- `GET /api/users` - Получить список пользователей (требуются параметры запроса limit и offset)
- `GET /api/user/{id}` - Получить пользователя по ID
- `POST /api/users` - Создать нового пользователя
- `PUT /api/user` - Обновить существующего пользователя
- `DELETE /api/user/{id}` - Удалить пользователя

### Права (Permissions)

- `GET /api/permissions` - Получить список прав (требуются параметры запроса limit и offset)
- `GET /api/permission/{id}` - Получить право по ID
- `POST /api/permissions` - Создать новое право
- `PUT /api/permission` - Обновить существующее право
- `DELETE /api/permission/{id}` - Удалить право

### Роли (Roles)

- `GET /api/roles` - Получить список ролей (требуются параметры запроса limit и offset)
- `GET /api/role/{id}` - Получить роль по ID
- `POST /api/roles` - Создать новую роль
- `PUT /api/role` - Обновить существующую роль
- `DELETE /api/role/{id}` - Удалить роль

### Организации

- `GET /api/organizations` - Получить список организаций (требуются параметры запроса limit и offset)
- `GET /api/organization/{id}` - Получить организацию по ID
- `POST /api/organizations` - Создать новую организацию
- `PUT /api/organization` - Обновить существующую организацию
- `DELETE /api/organization/{id}` - Удалить организацию

### Тарифы (Tariffs)

- `GET /api/tariffs` - Получить список тарифов (требуются параметры запроса limit и offset)
- `GET /api/tariff/{id}` - Получить тариф по ID
- `POST /api/tariffs` - Создать новый тариф
- `PUT /api/tariff` - Обновить существующий тариф
- `DELETE /api/tariff/{id}` - Удалить тариф

### Управление правами пользователей

- `POST /api/user/{id}/permissions/add` - Добавить права пользователю
- `POST /api/user/{id}/permissions/delete` - Удалить права у пользователя

### Управление ролями пользователей

- `POST /api/user/{id}/roles/add` - Добавить роли пользователю
- `POST /api/user/{id}/roles/delete` - Удалить роли у пользователя

### Управление правами организаций

- `POST /api/organization/{id}/permissions/add` - Добавить права организации
- `POST /api/organization/{id}/permissions/delete` - Удалить права у организации

### Управление ролями организаций

- `POST /api/organization/{id}/roles/add` - Добавить роли организации
- `POST /api/organization/{id}/roles/delete` - Удалить роли у организации

### Управление правами ролей

- `POST /api/role/{id}/permissions/add` - Добавить права роли
- `POST /api/role/{id}/permissions/delete` - Удалить права у роли

### Управление ролями тарифов

- `POST /api/tariff/{id}/roles/add` - Добавить роли тарифу
- `POST /api/tariff/{id}/roles/delete` - Удалить роли у тарифа

## Начало работы

1. Убедитесь, что у вас установлен Go
2. Установите зависимости: `go mod tidy`
3. Запустите сервер: `go run cmd/app/main.go`
4. Запустите cli: `go run cmd/cli/main.go`

## Примеры использования

### Аутентификация
```bash
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'
```

### Создание пользователя
```bash
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"John Doe","email":"john@example.com","password":"password","organization_id":1}'
```

### Создание организации
```bash
curl -X POST http://localhost:8080/api/organizations \
  -H "Content-Type: application/json" \
  -d '{"name":"Example Corp"}'
```

### Создание роли
```bash
curl -X POST http://localhost:8080/api/roles \
  -H "Content-Type: application/json" \
  -d '{"name":"Manager","code":"manager","description":"Organization manager"}'
```

### Назначение роли пользователю
```bash
curl -X POST http://localhost:8080/api/user/1/roles/add \
  -H "Content-Type: application/json" \
  -d '{"id":1,"role_ids":[1]}'
```

## Особенности

1. Связь пользователя и организации
  - нельзя удалить организацию, если она связана с пользователем
  - нельзя присвоить пользоватлю id несуществующей организации
  - может быть пользователь без организации
  - пользователь может состоять в нескольких организациях
2. ✅ Сохранение паролей в безопасном виде
3. ✅ Авторизация пользователя по паролю (email+password -> jwt)
4. Пользователь может редактировать только свои данные
5. ✅ Права (permissions)
6. ✅ Роли (roles) - одна роль может содержать несколько прав
7. ✅ Пользователь может получить определенный набор прав (по одному или пачкой получив роль)
8. Права отображаются в jwt
9. Пользователь с правом "Администратор" может редактировать всех пользователей
10. ✅ Организация может получить определенный набор прав (по одному или пачкой получив роль)
11. Пользователь с правом "Администратор" внутри организации, может редактировать всех пользователей в ней (кроме пароля)
12. ✅ Тарифы (tariffs)
13. ✅ Тарифы могут предоставлять ~~права~~ или роли с правами
14. Тарифы связаны с организациями и пользователями
15. Можно иметь несколько тарифов
16. Тарифы предоставляется пользователю или организации на ограниченный срок от, до
17. Тарифы могут иметь атрибуты (например цифровые)
18. Администратор может удалять пользователей из организации
19. Нельзя добавить нового пользователя в организацию если превышен лимит (атрибут из тарифа)
20. Пользователь добавляется в организацию только после подтверждения Администратор организации
21. Администратор организации может комбинировать права организации в роли (сложно)
    - может быть ограничиться перераспределением ролей